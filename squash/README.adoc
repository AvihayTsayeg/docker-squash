= `squash.py`

A PoC of a tool that squashes layers from a Docker image.

A new image will be created with all layers that are "above" the specified layers squashed. This new image will be tagged with the name provided at the invocation.

== Installation

----
$ pip install --user -r requirements.txt
----

== Usage

----
$ python squash.py -h
usage: squash.py [-h] [-t TMP_DIR] image layer tag

Squashes all layers in the image from the layer specified as "layer" argument.

positional arguments:
  image                 Image to be squashed
  layer                 ID of the layer or image ID or image name
  tag                   Specify the tag to be used for the new image

optional arguments:
  -h, --help            show this help message and exit
  -t TMP_DIR, --tmp-dir TMP_DIR
                        Temporary directory to be used
----

== Examples

----
$ python squash.py -t tmp ce-registry.usersys.redhat.com/jboss-base7/base:latest docker-registry.usersys.redhat.com/brew/rhel7:latest ce-registry.usersys.redhat.com/jboss-base7/base:latest-squashed
2015-05-05 12:30:12,686 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/ce-registry.usersys.redhat.com/jboss-base7/base:latest/json HTTP/1.1" 200 1910
2015-05-05 12:30:12,689 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/docker-registry.usersys.redhat.com/brew/rhel7:latest/json HTTP/1.1" 200 1321
2015-05-05 12:30:12,694 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/8208f1d26a3ac9ceab9a7bba15d6cc9ed34687dba7a6a967c628150f463cd547/json HTTP/1.1" 200 1910
2015-05-05 12:30:12,698 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/bde5cb024d1df3a3e1320363f60a681a2b3f4434be35dff0e9aa5448fa2b7cb8/json HTTP/1.1" 200 1908
2015-05-05 12:30:12,702 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/1dab485b3c718a3805c8b51d6ab7478597e77cb531e2eeb8d2ddc9ed5170b09e/json HTTP/1.1" 200 1869
2015-05-05 12:30:12,705 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/af9a95268cf2ab7c4e9afae541cec72fb72cb316aa3d7155575d6275335fb98d/json HTTP/1.1" 200 1948
2015-05-05 12:30:12,709 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/f9ea3a6ff6e1120bb486edce5c02e3e7f99f2957976cac8d6aca982921c9aed7/json HTTP/1.1" 200 None
2015-05-05 12:30:12,714 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/aabfbe187fbd6937fd0a984221700e27c004d42aa405fca3f39a92dc74e6f652/json HTTP/1.1" 200 1901
2015-05-05 12:30:12,716 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/10acc31def5d6f249b548e01e8ffbaccfd61af0240c17315a7ad393d022c5ca2/json HTTP/1.1" 200 1321
2015-05-05 12:30:12,716 root         DEBUG    Saving image 8208f1d26a3ac9ceab9a7bba15d6cc9ed34687dba7a6a967c628150f463cd547 to tmp/image.tar file...
2015-05-05 12:30:19,025 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/8208f1d26a3ac9ceab9a7bba15d6cc9ed34687dba7a6a967c628150f463cd547/get HTTP/1.1" 200 None
2015-05-05 12:30:19,431 root         DEBUG    Image saved!
2015-05-05 12:30:19,432 root         INFO     Unpacking exported tar (tmp/image.tar)...
2015-05-05 12:30:19,432 root         DEBUG    Unpacking tmp/image.tar tar file to tmp/old directory
2015-05-05 12:30:19,607 root         DEBUG    Archive unpacked!
2015-05-05 12:30:19,607 root         INFO     Removing exported tar (tmp/image.tar)...
2015-05-05 12:30:19,633 root         INFO     New layer ID for squashed content will be: 2e7ea4cb703fed68772c4897214fd050a86a31a9c100ec83fb861badbb973c2f
2015-05-05 12:30:19,633 root         DEBUG    Searching for marker files...
2015-05-05 12:30:19,633 root         DEBUG    Searching for marker files in 'tmp/old/aabfbe187fbd6937fd0a984221700e27c004d42aa405fca3f39a92dc74e6f652/layer.tar' archive...
2015-05-05 12:30:19,634 root         DEBUG    Searching for marker files in 'tmp/old/f9ea3a6ff6e1120bb486edce5c02e3e7f99f2957976cac8d6aca982921c9aed7/layer.tar' archive...
2015-05-05 12:30:19,694 root         DEBUG    Found 'var/lib/yum/rpmdb-indexes/.wh.conflicts' marker file
2015-05-05 12:30:19,694 root         DEBUG    Found 'var/lib/yum/rpmdb-indexes/.wh.file-requires' marker file
2015-05-05 12:30:19,694 root         DEBUG    Found 'var/lib/yum/rpmdb-indexes/.wh.obsoletes' marker file
2015-05-05 12:30:19,694 root         DEBUG    Found 'var/lib/yum/rpmdb-indexes/.wh.pkgtups-checksums' marker file
2015-05-05 12:30:19,694 root         DEBUG    Found 'var/lib/yum/rpmdb-indexes/.wh.version' marker file
2015-05-05 12:30:19,694 root         DEBUG    Searching for marker files in 'tmp/old/af9a95268cf2ab7c4e9afae541cec72fb72cb316aa3d7155575d6275335fb98d/layer.tar' archive...
2015-05-05 12:30:19,696 root         DEBUG    Searching for marker files in 'tmp/old/1dab485b3c718a3805c8b51d6ab7478597e77cb531e2eeb8d2ddc9ed5170b09e/layer.tar' archive...
2015-05-05 12:30:19,696 root         DEBUG    Searching for marker files in 'tmp/old/bde5cb024d1df3a3e1320363f60a681a2b3f4434be35dff0e9aa5448fa2b7cb8/layer.tar' archive...
2015-05-05 12:30:19,696 root         DEBUG    Searching for marker files in 'tmp/old/8208f1d26a3ac9ceab9a7bba15d6cc9ed34687dba7a6a967c628150f463cd547/layer.tar' archive...
2015-05-05 12:30:19,697 root         DEBUG    Following files were found: var/lib/yum/rpmdb-indexes/.wh.conflicts var/lib/yum/rpmdb-indexes/conflicts var/lib/yum/rpmdb-indexes/.wh.file-requires var/lib/yum/rpmdb-indexes/file-requires var/lib/yum/rpmdb-indexes/.wh.obsoletes var/lib/yum/rpmdb-indexes/obsoletes var/lib/yum/rpmdb-indexes/.wh.pkgtups-checksums var/lib/yum/rpmdb-indexes/pkgtups-checksums var/lib/yum/rpmdb-indexes/.wh.version var/lib/yum/rpmdb-indexes/version
2015-05-05 12:30:19,697 root         DEBUG    Starting squashing...
2015-05-05 12:30:19,697 root         DEBUG    Squashing layer aabfbe187fbd6937fd0a984221700e27c004d42aa405fca3f39a92dc74e6f652...
2015-05-05 12:30:19,697 root         DEBUG    Squashing layer f9ea3a6ff6e1120bb486edce5c02e3e7f99f2957976cac8d6aca982921c9aed7...
2015-05-05 12:30:19,861 root         DEBUG    Skipping 'var/lib/yum/rpmdb-indexes/.wh.conflicts' file because it's on the list to skip files
2015-05-05 12:30:19,862 root         DEBUG    Skipping 'var/lib/yum/rpmdb-indexes/.wh.file-requires' file because it's on the list to skip files
2015-05-05 12:30:19,862 root         DEBUG    Skipping 'var/lib/yum/rpmdb-indexes/.wh.obsoletes' file because it's on the list to skip files
2015-05-05 12:30:19,862 root         DEBUG    Skipping 'var/lib/yum/rpmdb-indexes/.wh.pkgtups-checksums' file because it's on the list to skip files
2015-05-05 12:30:19,862 root         DEBUG    Skipping 'var/lib/yum/rpmdb-indexes/.wh.version' file because it's on the list to skip files
2015-05-05 12:30:19,875 root         DEBUG    Squashing layer af9a95268cf2ab7c4e9afae541cec72fb72cb316aa3d7155575d6275335fb98d...
2015-05-05 12:30:19,878 root         DEBUG    Squashing layer 1dab485b3c718a3805c8b51d6ab7478597e77cb531e2eeb8d2ddc9ed5170b09e...
2015-05-05 12:30:19,879 root         DEBUG    Squashing layer bde5cb024d1df3a3e1320363f60a681a2b3f4434be35dff0e9aa5448fa2b7cb8...
2015-05-05 12:30:19,879 root         DEBUG    Squashing layer 8208f1d26a3ac9ceab9a7bba15d6cc9ed34687dba7a6a967c628150f463cd547...
2015-05-05 12:30:19,879 root         DEBUG    Squashing done!
2015-05-05 12:30:19,883 requests.packages.urllib3.connectionpool DEBUG    "GET /v1.18/images/8208f1d26a3ac9ceab9a7bba15d6cc9ed34687dba7a6a967c628150f463cd547/json HTTP/1.1" 200 1910
2015-05-05 12:30:19,884 root         DEBUG    Generating tar archive for the squashed image...
2015-05-05 12:30:19,974 root         DEBUG    Archive generated
2015-05-05 12:30:19,974 root         DEBUG    Uploading image...
2015-05-05 12:30:21,155 requests.packages.urllib3.connectionpool DEBUG    "POST /v1.18/images/load HTTP/1.1" 200 0
2015-05-05 12:30:21,157 root         DEBUG    Image uploaded
----
